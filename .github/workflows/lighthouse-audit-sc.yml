name: Lighthouse Audit - SC

on:
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  lighthouse-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Set timeout to 90 minutes (33 paths Ã— 2 configs = 66 reports)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: audit-lighthouse/package-lock.json

      - name: Install dependencies
        working-directory: ./audit-lighthouse
        run: npm ci

      - name: Install Chrome/Chromium
        run: |
          # Check if Chrome is already installed (GitHub Actions)
          if command -v google-chrome &> /dev/null; then
            echo "Chrome found at: $(which google-chrome)"
            echo "CHROME_PATH=$(which google-chrome)" >> $GITHUB_ENV
          elif command -v chromium-browser &> /dev/null; then
            echo "Chromium found at: $(which chromium-browser)"
            echo "CHROME_PATH=$(which chromium-browser)" >> $GITHUB_ENV
          else
            echo "Installing Chromium..."
            sudo apt-get update
            # Install dependencies first (required for Chromium to run)
            # Try to install all dependencies, some may have different names in newer Ubuntu
            sudo apt-get install -y \
              wget \
              unzip \
              curl \
              libnss3 \
              libnspr4 \
              libatk1.0-0 \
              libatk-bridge2.0-0 \
              libcups2 \
              libdrm2 \
              libdbus-1-3 \
              libxkbcommon0 \
              libxcomposite1 \
              libxdamage1 \
              libxfixes3 \
              libxrandr2 \
              libgbm1 \
              libpango-1.0-0 \
              libcairo2 \
              libatspi2.0-0 \
              libx11-6 \
              libx11-xcb1 \
              libxcb1 \
              libxcb-dri3-0 \
              libxcb-xfixes0 \
              libxshmfence1 \
              libxss1 \
              libgdk-pixbuf2.0-0 \
              libasound2t64 || sudo apt-get install -y libasound2
            # Download latest Chromium from official snapshots
            CHROMIUM_DIR="/opt/chromium"
            sudo mkdir -p $CHROMIUM_DIR
            cd /tmp
            # Get latest Chromium version
            LATEST=$(curl -s https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2FLAST_CHANGE?alt=media)
            echo "Downloading Chromium version: $LATEST"
            sudo wget -q "https://commondatastorage.googleapis.com/chromium-browser-snapshots/Linux_x64/${LATEST}/chrome-linux.zip" -O chrome-linux.zip
            sudo unzip -q chrome-linux.zip -d $CHROMIUM_DIR
            sudo rm chrome-linux.zip
            CHROME_BIN="${CHROMIUM_DIR}/chrome-linux/chrome"
            sudo chmod +x $CHROME_BIN
            echo "CHROME_PATH=${CHROME_BIN}" >> $GITHUB_ENV
            echo "Chromium installed at: ${CHROME_BIN}"
          fi
          echo "CHROME_PATH is set to: $CHROME_PATH"

      - name: Test Chrome installation
        run: |
          echo "Testing Chrome installation..."
          $CHROME_PATH --version || echo "Chrome version check failed"
          $CHROME_PATH --headless --disable-gpu --no-sandbox --dump-dom https://example.com > /dev/null 2>&1 && echo "Chrome test successful" || echo "Chrome test failed - may need additional dependencies"

      - name: Run Lighthouse audit
        working-directory: ./audit-lighthouse
        run: node audit.js audit-sites/sc.json

      - name: Upload reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports-sc-${{ github.run_number }}
          path: audit-lighthouse/reports/
          retention-days: 90
          if-no-files-found: warn

      - name: Summary
        run: |
          echo "## Lighthouse Audit Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** audit-sites/sc.json" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL:** https://www.scooterscoffee.com" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the reports from the artifacts section above." >> $GITHUB_STEP_SUMMARY

